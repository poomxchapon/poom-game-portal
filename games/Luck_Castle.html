<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luck Castle: LED Arcade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Orbitron:wght@400;700;900&family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cols: 6;
            --rows: 15;
            --tile-size: min(6vw, 3.8vh, 40px);
            --gap: 2px;
            --gold: #fbbf24;
            --gold-dim: #d97706;
            --gold-glow: rgba(251,191,36,0.4);
            --purple: #7c3aed;
            --purple-glow: rgba(124,58,237,0.3);
            --correct: #22c55e;
            --wrong: #ef4444;
            --bg: #0d0a18;
            --panel: #15102a;
            --panel-border: #2a1f45;
            --floor: #12101e;
            --zone-a: #ef4444;
            --zone-b: #3b82f6;
            --zone-c: #f59e0b;
            --zone-d: #22c55e;
            --wood: #4a2c1a;
            --wood-light: #6b4226;
            --wood-dark: #2e1a0e;
            --metal: #8a7a60;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Kanit', sans-serif;
            background: var(--bg);
            color: #e0e0e0;
            overflow: hidden;
            width: 100vw; height: 100vh;
            display: flex; align-items: center; justify-content: center;
            user-select: none;
            touch-action: none;
        }
        .font-castle { font-family: 'Cinzel', serif; }
        .font-arcade { font-family: 'Orbitron', sans-serif; }

        /* Scanline */
        .scanline {
            position: fixed; inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(124,58,237,0.005) 2px, rgba(124,58,237,0.005) 4px);
            pointer-events: none; z-index: 999;
        }

        /* Overlays */
        .overlay {
            position: fixed; inset: 0;
            background: rgba(6,4,16,0.97);
            backdrop-filter: blur(20px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 100; padding: 20px;
        }
        .overlay.hidden { display: none; }

        .menu-title {
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: clamp(2rem, 6vw, 3.5rem);
            letter-spacing: 8px;
            color: var(--gold);
            text-shadow: 0 0 40px var(--gold-glow), 0 2px 0 #b45309;
            line-height: 1;
        }
        .menu-sub {
            font-family: 'Cinzel', serif;
            font-size: 0.55rem;
            letter-spacing: 6px;
            color: #555;
        }
        .menu-divider {
            width: 120px; height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            opacity: 0.4; margin: 16px auto;
        }

        /* Castle decorative line */
        .castle-line {
            display: flex; align-items: center; gap: 8px;
            width: 200px; margin: 0 auto;
        }
        .castle-line::before, .castle-line::after {
            content: ''; flex: 1; height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            opacity: 0.3;
        }
        .castle-line .diamond {
            width: 6px; height: 6px;
            background: var(--gold);
            transform: rotate(45deg);
            opacity: 0.5;
        }

        /* Buttons */
        .btn-primary {
            font-family: 'Cinzel', serif;
            font-weight: 900; font-size: 0.85rem;
            letter-spacing: 4px; text-transform: uppercase;
            color: #1a0f00;
            background: linear-gradient(135deg, #fde68a, var(--gold), var(--gold-dim));
            border: 2px solid #d4a017;
            padding: 14px 44px;
            border-radius: 6px; cursor: pointer;
            box-shadow: 0 0 25px var(--gold-glow), 0 4px 16px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.3);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 40px var(--gold-glow); }
        .btn-primary:active { transform: scale(0.97); }
        .btn-ghost {
            font-family: 'Cinzel', serif;
            font-weight: 700; font-size: 0.65rem;
            letter-spacing: 3px; color: var(--gold);
            background: rgba(251,191,36,0.06);
            border: 1px solid rgba(251,191,36,0.2);
            padding: 10px 28px; border-radius: 6px;
            cursor: pointer; transition: all 0.15s;
        }
        .btn-ghost:hover { background: rgba(251,191,36,0.12); }

        /* Game Layout */
        #game-screen {
            display: none;
            width: 100vw; height: 100vh;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px;
        }

        /* HUD */
        .hud-top {
            display: flex; align-items: center; gap: 14px;
            justify-content: center; flex-wrap: wrap;
        }
        .hud-chip {
            display: flex; align-items: center; gap: 6px;
            padding: 3px 12px;
            background: var(--panel);
            border: 1px solid var(--panel-border);
            border-radius: 6px;
            font-size: 0.72rem;
        }
        .hud-chip .val {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900; font-size: 0.85rem;
        }

        /* Challenge Banner (Scroll Style) */
        #challenge-banner {
            width: 100%; max-width: 640px;
            background: linear-gradient(180deg, #1e1535, var(--panel), #1e1535);
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            padding: 10px 20px;
            text-align: center;
            position: relative;
        }
        #challenge-banner::before, #challenge-banner::after {
            content: '';
            position: absolute; left: 12px; right: 12px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(251,191,36,0.2), transparent);
        }
        #challenge-banner::before { top: 4px; }
        #challenge-banner::after { bottom: 4px; }
        #round-tag {
            position: absolute; top: -9px; left: 50%; transform: translateX(-50%);
            font-family: 'Cinzel', serif;
            font-size: 0.5rem; font-weight: 700;
            letter-spacing: 3px;
            color: var(--gold);
            background: var(--bg);
            padding: 1px 14px;
            border-radius: 8px;
            border: 1px solid var(--panel-border);
        }
        #challenge-text {
            font-size: clamp(0.95rem, 2.2vw, 1.15rem);
            font-weight: 600;
            color: #fff;
        }

        /* ═══ DOOR CARDS — The main differentiator ═══ */
        .doors-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 100%; max-width: 640px;
        }

        .door-card {
            flex: 1;
            max-width: 140px;
            aspect-ratio: 5/7;
            perspective: 800px;
            cursor: pointer;
            position: relative;
        }

        .door-inner {
            width: 100%; height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .door-card.flipped .door-inner {
            transform: rotateY(180deg);
        }

        .door-front, .door-back {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            border-radius: 40% 40% 6px 6px / 18% 18% 6px 6px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden;
        }

        /* Door Front — Wooden door look */
        .door-front {
            background:
                linear-gradient(transparent 30%, rgba(138,122,96,0.4) 31%, rgba(138,122,96,0.4) 33%, transparent 34%),
                linear-gradient(transparent 62%, rgba(138,122,96,0.4) 63%, rgba(138,122,96,0.4) 65%, transparent 66%),
                linear-gradient(180deg, var(--wood-light), var(--wood), var(--wood-dark), var(--wood));
            border: 3px solid var(--wood-light);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.4), 0 4px 16px rgba(0,0,0,0.5);
        }

        .door-front .door-emblem {
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: clamp(1.5rem, 4vw, 2.2rem);
            color: var(--gold);
            text-shadow: 0 0 15px var(--gold-glow), 0 2px 4px rgba(0,0,0,0.6);
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--gold);
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            margin-bottom: 8px;
        }

        .door-front .door-label {
            font-family: 'Kanit', sans-serif;
            font-weight: 600;
            font-size: clamp(0.7rem, 1.6vw, 0.85rem);
            color: #ddd;
            text-shadow: 0 1px 4px rgba(0,0,0,0.8);
            padding: 2px 10px;
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
        }

        /* Zone color stripe at bottom */
        .door-front .zone-stripe {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 6px; border-radius: 0 0 3px 3px;
        }
        .door-card[data-zone="a"] .zone-stripe { background: var(--zone-a); box-shadow: 0 0 10px var(--zone-a); }
        .door-card[data-zone="b"] .zone-stripe { background: var(--zone-b); box-shadow: 0 0 10px var(--zone-b); }
        .door-card[data-zone="c"] .zone-stripe { background: var(--zone-c); box-shadow: 0 0 10px var(--zone-c); }
        .door-card[data-zone="d"] .zone-stripe { background: var(--zone-d); box-shadow: 0 0 10px var(--zone-d); }

        /* Door handle (small circle) */
        .door-front .door-handle {
            position: absolute;
            right: 16%; top: 50%;
            width: 14px; height: 14px;
            background: radial-gradient(circle at 35% 35%, #f0e0b8, #b8a060, #8a7a50);
            border-radius: 50%;
            border: 1.5px solid #6a5a30;
            box-shadow: 0 1px 6px rgba(0,0,0,0.6), 0 0 8px rgba(251,191,36,0.15);
        }

        /* Door Back — Revealed treasure */
        .door-back {
            transform: rotateY(180deg);
            border: 3px solid;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .door-back .back-pts {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: clamp(1.4rem, 4vw, 2rem);
        }
        .door-back .back-icon {
            font-size: 1.6rem;
            margin-bottom: 4px;
        }

        .door-back.treasure-high {
            background: linear-gradient(135deg, #1a3a1a, #0d2a0d);
            border-color: var(--correct);
        }
        .door-back.treasure-high .back-pts { color: var(--correct); text-shadow: 0 0 20px rgba(34,197,94,0.5); }

        .door-back.treasure-mid {
            background: linear-gradient(135deg, #1a2040, #0d1530);
            border-color: #60a5fa;
        }
        .door-back.treasure-mid .back-pts { color: #60a5fa; text-shadow: 0 0 15px rgba(96,165,250,0.4); }

        .door-back.treasure-zero {
            background: linear-gradient(135deg, #1a1a1a, #111);
            border-color: #444;
        }
        .door-back.treasure-zero .back-pts { color: #555; }

        .door-back.treasure-neg {
            background: linear-gradient(135deg, #3a1515, #2a0d0d);
            border-color: var(--wrong);
        }
        .door-back.treasure-neg .back-pts { color: var(--wrong); text-shadow: 0 0 15px rgba(239,68,68,0.4); }

        .door-back.treasure-jackpot {
            background: linear-gradient(135deg, #3a2a0a, #2a1a00);
            border-color: var(--gold);
            box-shadow: 0 0 30px var(--gold-glow), 0 4px 20px rgba(0,0,0,0.5);
        }
        .door-back.treasure-jackpot .back-pts {
            color: var(--gold);
            text-shadow: 0 0 30px var(--gold-glow);
            animation: jackpotGlow 0.5s ease-in-out infinite alternate;
        }
        @keyframes jackpotGlow { from{text-shadow:0 0 20px var(--gold-glow);} to{text-shadow:0 0 40px var(--gold-glow), 0 0 60px var(--gold-glow);} }

        /* Door States */
        .door-card.active .door-front {
            animation: doorPulse 1s ease-in-out infinite;
        }
        .door-card.active[data-zone="a"] .door-front { border-color: var(--zone-a); box-shadow: 0 0 25px rgba(239,68,68,0.5), inset 0 0 20px rgba(0,0,0,0.4); }
        .door-card.active[data-zone="b"] .door-front { border-color: var(--zone-b); box-shadow: 0 0 25px rgba(59,130,246,0.5), inset 0 0 20px rgba(0,0,0,0.4); }
        .door-card.active[data-zone="c"] .door-front { border-color: var(--zone-c); box-shadow: 0 0 25px rgba(245,158,11,0.5), inset 0 0 20px rgba(0,0,0,0.4); }
        .door-card.active[data-zone="d"] .door-front { border-color: var(--zone-d); box-shadow: 0 0 25px rgba(34,197,94,0.5), inset 0 0 20px rgba(0,0,0,0.4); }
        @keyframes doorPulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.03);} }

        /* Lock progress bar on door */
        .door-card.locking::after {
            content: '';
            position: absolute; bottom: 0; left: 3px; right: 3px;
            height: 8px;
            border-radius: 0 0 4px 4px;
            z-index: 5;
            animation: lockProgress 3s linear forwards;
        }
        .door-card.locking[data-zone="a"]::after { background: var(--zone-a); box-shadow: 0 0 10px var(--zone-a); }
        .door-card.locking[data-zone="b"]::after { background: var(--zone-b); box-shadow: 0 0 10px var(--zone-b); }
        .door-card.locking[data-zone="c"]::after { background: var(--zone-c); box-shadow: 0 0 10px var(--zone-c); }
        .door-card.locking[data-zone="d"]::after { background: var(--zone-d); box-shadow: 0 0 10px var(--zone-d); }
        @keyframes lockProgress { from{width:0%;} to{width:calc(100% - 6px);} }

        /* My pick highlight */
        .door-card.my-pick .door-front,
        .door-card.my-pick .door-back {
            box-shadow: 0 0 0 3px #fff, 0 0 25px rgba(255,255,255,0.3) !important;
        }

        /* Dimmed during reveal */
        .door-card.dimmed { opacity: 0.5; }
        .door-card.my-pick.dimmed { opacity: 1; }

        /* Focus states for keyboard navigation */
        .door-card:focus-visible {
            outline: 2px solid var(--gold);
            outline-offset: 4px;
            border-radius: 8px;
        }
        .btn-primary:focus-visible, .btn-ghost:focus-visible {
            outline: 2px solid var(--gold);
            outline-offset: 3px;
        }
        .tile:focus-visible {
            outline: 2px solid #fff;
            outline-offset: -2px;
        }

        /* Timer */
        .timer-track {
            width: 100%; max-width: 640px;
            height: 7px;
            background: #1a1530;
            border-radius: 4px; overflow: hidden;
        }
        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--purple));
            border-radius: 3px;
            transition: width 0.15s linear;
        }
        .timer-fill.urgent { background: linear-gradient(90deg, var(--wrong), #ff6600); }

        /* Grid */
        #grid-wrap { position: relative; display: flex; align-items: center; justify-content: center; }
        #game-grid {
            display: grid;
            grid-template-columns: repeat(var(--cols), var(--tile-size));
            grid-template-rows: repeat(var(--rows), var(--tile-size));
            gap: var(--gap);
            padding: 3px;
            background: #0a0818;
            border: 1px solid var(--panel-border);
            border-radius: 6px;
            box-shadow: 0 0 20px rgba(124,58,237,0.05), inset 0 0 30px rgba(0,0,0,0.5);
            position: relative;
        }
        .tile {
            width: 100%; height: 100%;
            background-color: var(--floor);
            border-radius: 2px;
            transition: background-color 0.12s;
            cursor: pointer;
        }
        .tile.za { background: var(--zone-a); box-shadow: inset 0 0 6px rgba(0,0,0,0.3); }
        .tile.zb { background: var(--zone-b); box-shadow: inset 0 0 6px rgba(0,0,0,0.3); }
        .tile.zc { background: var(--zone-c); box-shadow: inset 0 0 6px rgba(0,0,0,0.3); }
        .tile.zd { background: var(--zone-d); box-shadow: inset 0 0 6px rgba(0,0,0,0.3); }
        .tile.za-dim { background: rgba(239,68,68,0.1); }
        .tile.zb-dim { background: rgba(59,130,246,0.1); }
        .tile.zc-dim { background: rgba(245,158,11,0.1); }
        .tile.zd-dim { background: rgba(34,197,94,0.1); }
        .tile.flash-gold { background: var(--gold) !important; box-shadow: 0 0 12px var(--gold) !important; }
        .tile.flash-bad { background: #333 !important; }

        /* Player */
        #player {
            position: absolute;
            width: var(--tile-size); height: var(--tile-size);
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #fef3c7, #fbbf24 60%, #b45309);
            border: 2px solid rgba(255,255,255,0.85);
            box-shadow: 0 0 14px var(--gold), 0 0 4px #fff;
            z-index: 30;
            transition: left 0.08s ease-out, top 0.08s ease-out;
            pointer-events: none;
        }
        #player::after {
            content: '';
            width: 35%; height: 35%;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            position: absolute; top: 18%; left: 20%;
            filter: blur(1px);
        }

        /* Zone labels */
        .zone-lbl {
            position: absolute;
            font-family: 'Kanit', sans-serif;
            font-weight: 700;
            font-size: clamp(10px, 1.6vw, 14px);
            color: #fff;
            text-shadow: 0 2px 8px rgba(0,0,0,0.9);
            z-index: 25; pointer-events: none;
            text-align: center;
            max-width: 45%; line-height: 1.2;
            padding: 3px 7px; border-radius: 4px;
        }
        .zone-lbl.lbl-a { background: rgba(239,68,68,0.7); }
        .zone-lbl.lbl-b { background: rgba(59,130,246,0.7); }
        .zone-lbl.lbl-c { background: rgba(245,158,11,0.7); }
        .zone-lbl.lbl-d { background: rgba(34,197,94,0.7); }

        /* Hint */
        .hint-bar {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.55rem;
            letter-spacing: 2px;
            color: #666;
            text-align: center;
        }

        /* Point Popup */
        #point-popup {
            position: fixed; inset: 0;
            display: none; align-items: center; justify-content: center;
            z-index: 90; pointer-events: none;
        }
        #point-popup.show { display: flex; }
        .point-big {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: clamp(3rem, 10vw, 6rem);
            animation: pointPop 1s ease-out forwards;
        }
        .point-big.good { color: var(--gold); text-shadow: 0 0 60px var(--gold-glow); }
        .point-big.bad { color: #666; }
        .point-big.neg { color: var(--wrong); text-shadow: 0 0 40px rgba(239,68,68,0.4); }
        .point-big.jackpot { color: var(--gold); text-shadow: 0 0 80px var(--gold-glow), 0 0 120px var(--gold-glow); }
        @keyframes pointPop {
            0% { transform: scale(0); opacity: 0; }
            30% { transform: scale(1.3); opacity: 1; }
            60% { transform: scale(1); }
            100% { transform: scale(1) translateY(-20px); opacity: 0; }
        }

        /* Countdown */
        .countdown-num {
            font-family: 'Cinzel', serif;
            font-size: 6rem; font-weight: 900;
            color: var(--gold);
            text-shadow: 0 0 60px var(--gold-glow), 0 4px 0 #b45309;
            animation: countIn 0.5s ease-out;
        }
        @keyframes countIn {
            0% { transform: scale(1.6); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1); }
        }

        /* Game Over */
        .stat-box {
            text-align: center; padding: 10px 14px;
            background: var(--panel);
            border: 1px solid var(--panel-border);
            border-radius: 8px;
        }
        .stat-val {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900; font-size: 1.5rem;
        }
        .stat-label { font-size: 0.55rem; color: #555; margin-top: 2px; letter-spacing: 1px; }
        .result-row {
            display: flex; gap: 8px; align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #1a1530;
            font-size: 0.72rem;
        }
        .result-dot {
            width: 22px; height: 22px;
            border-radius: 4px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.55rem; font-weight: 700;
            font-family: 'Orbitron', sans-serif;
        }

        /* Sparkle */
        .sparkle {
            position: fixed;
            width: 6px; height: 6px;
            background: var(--gold);
            border-radius: 50%;
            pointer-events: none; z-index: 95;
            animation: sparkleAnim 0.8s ease-out forwards;
        }
        @keyframes sparkleAnim {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0) translateY(-40px); opacity: 0; }
        }

        /* Screen reader only */
        .sr-only {
            position: absolute; width: 1px; height: 1px;
            padding: 0; margin: -1px; overflow: hidden;
            clip: rect(0,0,0,0); white-space: nowrap; border: 0;
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            .door-inner { transition: none; }
            .door-card.flipped .door-inner { transform: rotateY(180deg); }
            .scanline { display: none; }
        }

        /* Responsive */
        @media (max-height: 700px) {
            :root { --tile-size: min(5vw, 3vh, 32px); }
            .door-card { max-width: 110px; }
        }
        @media (max-height: 600px) {
            :root { --tile-size: min(4vw, 2.5vh, 26px); }
            .door-card { max-width: 90px; }
            .door-front .door-emblem { width: 32px; height: 32px; font-size: 1.2rem; }
        }
        @media (max-width: 500px) {
            :root { --tile-size: min(10vw, 3.5vh, 34px); }
            .doors-row { gap: 6px; }
            .door-card { max-width: 75px; }
            .door-front .door-emblem { width: 30px; height: 30px; font-size: 1rem; }
            .hud-chip { padding: 2px 8px; font-size: 0.65rem; }
        }
    </style>
</head>
<body>
<div class="scanline"></div>

<!-- MAIN MENU -->
<div id="menu" class="overlay">
    <div style="text-align:center;max-width:420px;width:90vw;">
        <div class="menu-sub">CSM-C1-011</div>
        <div class="menu-title" style="margin:6px 0 4px;">LUCK<br>CASTLE</div>
        <div class="castle-line"><div class="diamond"></div></div>
        <div style="font-size:0.9rem;color:#c4a265;margin:14px 0 4px;font-family:'Cinzel',serif;font-weight:700;">Party Game</div>
        <div style="font-size:0.78rem;color:#777;max-width:320px;margin:0 auto 20px;line-height:1.7;">
            เลือกประตูที่คิดว่าโชคดี<br>
            เดินไปยืนบนโซนสีนั้น แล้วรอเฉลย<br>
            เปิดประตูทีละบาน — ดวงดี = คะแนนเยอะ!
        </div>
        <button class="btn-primary" onclick="beginGame()">Enter the Castle</button>
        <div style="font-size:0.5rem;color:#333;margin-top:12px;font-family:'Orbitron',sans-serif;letter-spacing:2px;">
            WASD / ARROWS &middot; 10 ROUNDS &middot; STAND 3s = CONFIRM
        </div>
    </div>
</div>

<!-- COUNTDOWN -->
<div id="countdown" class="overlay hidden">
    <div id="count-num" class="countdown-num"></div>
</div>

<!-- GAME OVER -->
<div id="gameover" class="overlay hidden">
    <div style="text-align:center;max-width:420px;width:90vw;">
        <div class="menu-sub" style="margin-bottom:4px;">THE CASTLE HAS SPOKEN</div>
        <div id="final-score" class="menu-title" style="font-size:2.5rem;"></div>
        <div class="menu-sub" style="margin-top:2px;">POINTS</div>
        <div id="luck-rank" style="font-size:1rem;margin:8px 0;"></div>
        <div class="menu-divider"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px;">
            <div class="stat-box"><div id="s-best" class="stat-val" style="color:var(--gold);">0</div><div class="stat-label">BEST</div></div>
            <div class="stat-box"><div id="s-worst" class="stat-val" style="color:#666;">0</div><div class="stat-label">WORST</div></div>
            <div class="stat-box"><div id="s-avg" class="stat-val" style="color:var(--purple);">0</div><div class="stat-label">AVERAGE</div></div>
        </div>
        <div id="results-list" style="text-align:left;max-height:160px;overflow-y:auto;margin-bottom:14px;"></div>
        <div style="display:flex;gap:10px;justify-content:center;">
            <button class="btn-primary" onclick="beginGame()" style="font-size:0.7rem;padding:12px 28px;">PLAY AGAIN</button>
            <button class="btn-ghost" onclick="goMenu()">MENU</button>
        </div>
    </div>
</div>

<!-- POINT POPUP -->
<div id="point-popup"><div id="point-text" class="point-big"></div></div>

<!-- GAME SCREEN -->
<div id="game-screen">
    <div class="hud-top">
        <div class="hud-chip"><span style="color:#888;">Round</span> <span id="h-round" class="val" style="color:var(--gold);">1</span><span style="color:#444;font-size:0.7rem;">/10</span></div>
        <div class="hud-chip"><span style="color:#888;">Score</span> <span id="h-score" class="val" style="color:var(--gold);">0</span></div>
        <div class="hud-chip"><span style="color:#888;">Time</span> <span id="h-time" class="val" style="color:var(--purple);">8</span></div>
    </div>

    <div id="challenge-banner">
        <div id="round-tag">ROUND 1 / 10</div>
        <div id="challenge-text">-</div>
    </div>

    <!-- 4 CASTLE DOORS -->
    <div class="doors-row" id="doors-row" role="group" aria-label="4 ประตูให้เลือก">
        <div class="door-card" data-i="0" data-zone="a" onclick="goToZone(0)" tabindex="0" role="button" aria-label="ประตู A">
            <div class="door-inner">
                <div class="door-front">
                    <div class="door-emblem">?</div>
                    <div class="door-label" id="dl-0"></div>
                    <div class="door-handle"></div>
                    <div class="zone-stripe"></div>
                </div>
                <div class="door-back" id="db-0">
                    <div class="back-pts"></div>
                </div>
            </div>
        </div>
        <div class="door-card" data-i="1" data-zone="b" onclick="goToZone(1)" tabindex="0" role="button" aria-label="ประตู B">
            <div class="door-inner">
                <div class="door-front">
                    <div class="door-emblem">?</div>
                    <div class="door-label" id="dl-1"></div>
                    <div class="door-handle"></div>
                    <div class="zone-stripe"></div>
                </div>
                <div class="door-back" id="db-1">
                    <div class="back-pts"></div>
                </div>
            </div>
        </div>
        <div class="door-card" data-i="2" data-zone="c" onclick="goToZone(2)" tabindex="0" role="button" aria-label="ประตู C">
            <div class="door-inner">
                <div class="door-front">
                    <div class="door-emblem">?</div>
                    <div class="door-label" id="dl-2"></div>
                    <div class="door-handle"></div>
                    <div class="zone-stripe"></div>
                </div>
                <div class="door-back" id="db-2">
                    <div class="back-pts"></div>
                </div>
            </div>
        </div>
        <div class="door-card" data-i="3" data-zone="d" onclick="goToZone(3)" tabindex="0" role="button" aria-label="ประตู D">
            <div class="door-inner">
                <div class="door-front">
                    <div class="door-emblem">?</div>
                    <div class="door-label" id="dl-3"></div>
                    <div class="door-handle"></div>
                    <div class="zone-stripe"></div>
                </div>
                <div class="door-back" id="db-3">
                    <div class="back-pts"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="timer-track"><div id="timer-fill" class="timer-fill"></div></div>

    <div id="grid-wrap">
        <div id="game-grid"></div>
        <div id="player"></div>
    </div>

    <div class="hint-bar" id="hint-bar" role="status">WALK TO A ZONE &middot; STAND 3s = CONFIRM &middot; WASD / ARROWS</div>
    <div id="sr-announce" class="sr-only" aria-live="polite" aria-atomic="true"></div>
</div>

<script>
// ═══════════════════════════════════════════
//  LUCK CASTLE — Engine v2 (Door Card Edition)
// ═══════════════════════════════════════════
const COLS=6, ROWS=15, QTIME=8, ROUNDS=10;
const ZCOLORS=['za','zb','zc','zd'];
const ZDIM=['za-dim','zb-dim','zc-dim','zd-dim'];
const ZONE_KEYS=['a','b','c','d'];

const G = {
    round:0, score:0, results:[],
    pr:7, pc:3, timer:QTIME, tiv:null,
    confirmed:false, active:false,
    currentZone:-1, lockTimer:null,
    challenges:[], pointMap:[],
};

// Challenge Pool
const CHALLENGES = [
    { cmd:"เลือกประตูที่คิดว่าโชคดี", opts:["ประตูแดง","ประตูน้ำเงิน","ประตูทอง","ประตูเขียว"] },
    { cmd:"เปิดหีบสมบัติ", opts:["หีบทอง","หีบเงิน","หีบไม้","หีบคริสตัล"] },
    { cmd:"เลือกห้องในปราสาท", opts:["บัลลังก์","ห้องสมบัติ","ห้องลับ","สวนลอย"] },
    { cmd:"เลือกอัญมณีแห่งโชค", opts:["ทับทิม","ไพลิน","มรกต","เพชร"] },
    { cmd:"เลือกเส้นทางลึกลับ", opts:["ถ้ำมังกร","สะพานรุ้ง","ป่าเวท","ทะเลทราย"] },
    { cmd:"เลือกสัตว์นำโชค", opts:["มังกร","หงส์","สิงโต","นกฮูก"] },
    { cmd:"เลือกคาถาเสี่ยงโชค", opts:["เสริมพลัง","เกราะ","เรียกทอง","สายฟ้า"] },
    { cmd:"เลือกดาวนำทาง", opts:["ดาวเหนือ","ดาวใต้","ดาวรุ่ง","ดาวตก"] },
    { cmd:"เลือกธาตุที่เป็นตัวคุณ", opts:["ไฟ","น้ำ","ลม","ดิน"] },
    { cmd:"เลือกอาวุธแห่งโชค", opts:["ดาบ","ธนู","ไม้เท้า","โล่"] },
    { cmd:"เลือกเครื่องดื่มวิเศษ", opts:["ยาพลัง","น้ำทอง","ชาวิเศษ","น้ำผลไม้"] },
    { cmd:"เลือกฤดูกาลแห่งโชค", opts:["ร้อน","ฝน","หนาว","ใบไม้ร่วง"] },
    { cmd:"เลือกตัวเลขโชคลาภ", opts:["7","8","9","13"] },
    { cmd:"เลือกทิศที่นำโชค", opts:["เหนือ","ใต้","ตะวันออก","ตะวันตก"] },
    { cmd:"เลือกสีที่คิดว่าโชคดี", opts:["แดง","น้ำเงิน","เหลือง","เขียว"] },
];

// Point distributions
const POINT_POOLS = [
    [0, 5, 10, 20],
    [5, 5, 10, 15],
    [0, 0, 15, 25],
    [0, 10, 10, 10],
    [5, 5, 5, 30],
    [-5, 10, 10, 20],
    [0, 0, 0, 50],
    [10, 10, 10, 10],
    [0, 5, 15, 20],
    [-10, 5, 20, 30],
];

function zones(){
    return [
        {sr:1,er:4,sc:0,ec:2},   // A = top-left
        {sr:1,er:4,sc:3,ec:5},   // B = top-right
        {sr:10,er:13,sc:0,ec:2}, // C = bottom-left
        {sr:10,er:13,sc:3,ec:5}, // D = bottom-right
    ];
}

function idx(r,c){return r*COLS+c;}
function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}

// Build Grid
function buildGrid(){
    const g=document.getElementById('game-grid');
    g.innerHTML='';
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
        const d=document.createElement('div');
        d.className='tile';
        d.dataset.r=r;d.dataset.c=c;
        d.addEventListener('click',()=>{G.pr=r;G.pc=c;moveP();checkZone();});
        g.appendChild(d);
    }
}

function moveP(){
    G.pr=Math.max(0,Math.min(ROWS-1,G.pr));
    G.pc=Math.max(0,Math.min(COLS-1,G.pc));
    const p=document.getElementById('player');
    const grid=document.getElementById('game-grid');
    const tile=document.querySelector(`.tile[data-r="${G.pr}"][data-c="${G.pc}"]`);
    if(!tile) return;
    p.style.width=tile.offsetWidth+'px';
    p.style.height=tile.offsetHeight+'px';
    p.style.left=(grid.offsetLeft+tile.offsetLeft)+'px';
    p.style.top=(grid.offsetTop+tile.offsetTop)+'px';
}

// Display Zones + Doors
function showZones(opts){
    const tiles=document.querySelectorAll('.tile');
    tiles.forEach(t=>t.className='tile');
    const zz=zones();
    zz.forEach((z,i)=>{
        if(i>=opts.length) return;
        for(let r=z.sr;r<=z.er;r++) for(let c=z.sc;c<=z.ec;c++)
            tiles[idx(r,c)].classList.add(ZDIM[i]);
        const cr=Math.floor((z.sr+z.er)/2), cc=Math.floor((z.sc+z.ec)/2);
        for(let r=cr;r<=cr+1;r++) for(let c=cc;c<=cc+1;c++)
            if(r<ROWS&&c<COLS){ tiles[idx(r,c)].classList.remove(ZDIM[i]); tiles[idx(r,c)].classList.add(ZCOLORS[i]); }
    });

    // Update door labels
    const doors=document.querySelectorAll('.door-card');
    doors.forEach((d,i)=>{
        d.classList.remove('flipped','active','locking','my-pick','dimmed');
        d.style.display=i<opts.length?'':'none';
        document.getElementById('dl-'+i).textContent=opts[i]||'';
        // Reset back
        const back=document.getElementById('db-'+i);
        back.className='door-back';
        back.querySelector('.back-pts').textContent='';
    });

    // Zone labels on grid
    document.querySelectorAll('.zone-lbl').forEach(l=>l.remove());
    setTimeout(()=>{
        const grid=document.getElementById('game-grid');
        const wrap=document.getElementById('grid-wrap');
        zz.forEach((z,i)=>{
            if(i>=opts.length) return;
            const cr=Math.floor((z.sr+z.er)/2), cc=Math.floor((z.sc+z.ec)/2);
            const ref=document.querySelector(`.tile[data-r="${cr}"][data-c="${cc}"]`);
            if(!ref) return;
            const lbl=document.createElement('div');
            lbl.className='zone-lbl lbl-'+ZONE_KEYS[i];
            lbl.textContent=opts[i];
            lbl.style.left=(grid.offsetLeft+ref.offsetLeft)+'px';
            lbl.style.top=(grid.offsetTop+ref.offsetTop)+'px';
            wrap.appendChild(lbl);
        });
    },60);
}

// Zone Detection
function checkZone(){
    if(!G.active||G.confirmed) return;
    const zz=zones();
    let found=-1;
    for(let i=0;i<zz.length;i++){
        const z=zz[i];
        if(G.pr>=z.sr&&G.pr<=z.er&&G.pc>=z.sc&&G.pc<=z.ec){found=i;break;}
    }
    if(found!==G.currentZone){
        clearTimeout(G.lockTimer); G.lockTimer=null;
        G.currentZone=found;
        updateDoorIndicator();
        if(found>=0){
            G.lockTimer=setTimeout(()=>{
                if(!G.confirmed&&G.active&&G.currentZone>=0){
                    clearInterval(G.tiv);
                    confirmChoice(G.currentZone);
                }
            },3000);
        }
    }
}

function updateDoorIndicator(){
    const doors=document.querySelectorAll('.door-card');
    doors.forEach((d,i)=>{
        const isActive=i===G.currentZone;
        d.classList.toggle('active',isActive);
        if(!isActive) d.classList.remove('locking');
    });
    if(G.currentZone>=0){
        const door=doors[G.currentZone];
        if(!door.classList.contains('locking')){
            void door.offsetWidth;
            door.classList.add('locking');
        }
    }
    const hint=document.getElementById('hint-bar');
    if(G.currentZone>=0){
        const labels=['A','B','C','D'];
        hint.textContent='DOOR '+labels[G.currentZone]+' SELECTED — HOLD 3s TO CONFIRM';
        hint.style.color='var(--gold)';
    } else {
        hint.textContent='WALK TO A ZONE · STAND 3s = CONFIRM · WASD / ARROWS';
        hint.style.color='';
    }
}

function goToZone(i){
    if(!G.active||G.confirmed) return;
    const zz=zones();
    if(i>=zz.length) return;
    const z=zz[i];
    G.pr=Math.floor((z.sr+z.er)/2);
    G.pc=Math.floor((z.sc+z.ec)/2);
    moveP();
    checkZone();
}

// Confirm & Reveal (Door Flip!)
function confirmChoice(ci){
    G.confirmed=true;
    clearTimeout(G.lockTimer); G.lockTimer=null;
    clearInterval(G.tiv);

    const pts=G.pointMap;
    const myPts=pts[ci];
    G.score+=myPts;
    const ch=G.challenges[G.round];
    G.results.push({cmd:ch.cmd, pick:ch.opts[ci], pts:myPts, allPts:[...pts]});

    const doors=document.querySelectorAll('.door-card');
    doors.forEach(d=>d.classList.remove('active','locking'));
    doors[ci].classList.add('my-pick');

    // Prepare backs
    for(let i=0;i<4;i++){
        const p=pts[i];
        const back=document.getElementById('db-'+i);
        back.className='door-back '+treasureClass(p);
        back.querySelector('.back-pts').textContent=(p>0?'+':'')+p;
    }

    // Flip doors one by one
    flipDoors(pts, ci, 0);
}

function flipDoors(pts, myPick, i){
    if(i>=4){
        setTimeout(()=>{
            showPointPopup(pts[myPick]);
            hud();
            setTimeout(()=>nextRound(), 1200);
        }, 400);
        return;
    }
    const doors=document.querySelectorAll('.door-card');
    const tiles=document.querySelectorAll('.tile');
    const zz=zones();

    setTimeout(()=>{
        const door=doors[i];
        door.classList.add('flipped');
        if(i!==myPick) door.classList.add('dimmed');

        // Flash grid zone
        const z=zz[i];
        const p=pts[i];
        if(p>=20){
            for(let r=z.sr;r<=z.er;r++) for(let c=z.sc;c<=z.ec;c++) tiles[idx(r,c)].classList.add('flash-gold');
        } else if(p<=0){
            for(let r=z.sr;r<=z.er;r++) for(let c=z.sc;c<=z.ec;c++) tiles[idx(r,c)].classList.add('flash-bad');
        }

        flipDoors(pts, myPick, i+1);
    }, 450);
}

function treasureClass(p){
    if(p>=30) return 'treasure-jackpot';
    if(p>=15) return 'treasure-high';
    if(p>0) return 'treasure-mid';
    if(p===0) return 'treasure-zero';
    return 'treasure-neg';
}

function showPointPopup(pts){
    const el=document.getElementById('point-popup');
    const txt=document.getElementById('point-text');
    txt.textContent=(pts>0?'+':'')+pts;
    txt.className='point-big '+(pts>=30?'jackpot':pts>=10?'good':pts>0?'good':pts===0?'bad':'neg');
    el.classList.add('show');
    txt.style.animation='none'; void txt.offsetWidth; txt.style.animation='';
    if(pts>=15) spawnSparkles(10);
    announce('ได้ '+(pts>=0?'+':'')+pts+' คะแนน รวม '+G.score+' คะแนน');
    setTimeout(()=>el.classList.remove('show'),1000);
}

function spawnSparkles(n){
    for(let i=0;i<n;i++){
        const s=document.createElement('div');
        s.className='sparkle';
        s.style.left=(35+Math.random()*30)+'vw';
        s.style.top=(25+Math.random()*25)+'vh';
        s.style.animationDelay=(Math.random()*0.3)+'s';
        document.body.appendChild(s);
        setTimeout(()=>s.remove(),1200);
    }
}

// Timer expired
function timeUp(){
    if(G.confirmed) return;
    clearInterval(G.tiv);
    clearTimeout(G.lockTimer); G.lockTimer=null;

    if(G.currentZone>=0){
        confirmChoice(G.currentZone);
    } else {
        G.confirmed=true;
        const ch=G.challenges[G.round];
        G.results.push({cmd:ch.cmd, pick:'ไม่ได้เลือก', pts:0, allPts:[...G.pointMap]});
        const doors=document.querySelectorAll('.door-card');
        doors.forEach(d=>d.classList.remove('active','locking'));
        // Prepare backs then flip all
        for(let i=0;i<4;i++){
            const p=G.pointMap[i];
            const back=document.getElementById('db-'+i);
            back.className='door-back '+treasureClass(p);
            back.querySelector('.back-pts').textContent=(p>0?'+':'')+p;
        }
        flipDoors(G.pointMap, -1, 0);
        document.getElementById('hint-bar').textContent='NO DOOR CHOSEN — 0 POINTS';
        document.getElementById('hint-bar').style.color='var(--wrong)';
    }
}

// Round Flow
function nextRound(){
    document.querySelectorAll('.zone-lbl').forEach(l=>l.remove());
    G.round++;
    if(G.round>=ROUNDS){endGame();return;}
    showRound();
}

function showRound(){
    const ch=G.challenges[G.round];
    G.confirmed=false;
    G.timer=QTIME;
    G.pr=7;G.pc=3;
    G.currentZone=-1;
    clearTimeout(G.lockTimer); G.lockTimer=null;

    const pool=shuffle(POINT_POOLS)[0];
    G.pointMap=shuffle(pool);

    document.getElementById('challenge-text').textContent=ch.cmd;
    document.getElementById('round-tag').textContent='ROUND '+(G.round+1)+' / '+ROUNDS;
    document.getElementById('h-round').textContent=G.round+1;

    showZones(ch.opts);
    moveP();
    hud();
    startTimer();
    announce('รอบที่ '+(G.round+1)+': '+ch.cmd);
}

function startTimer(){
    clearInterval(G.tiv);
    G.timer=QTIME;
    updTimer();
    G.tiv=setInterval(()=>{
        G.timer-=0.1;
        if(G.timer<=0){G.timer=0;clearInterval(G.tiv);timeUp();}
        updTimer();
    },100);
}

function updTimer(){
    const pct=(G.timer/QTIME)*100;
    const f=document.getElementById('timer-fill');
    f.style.width=pct+'%';
    f.classList.toggle('urgent',G.timer<3);
    document.getElementById('h-time').textContent=Math.ceil(G.timer);
    if(G.timer<3&&G.currentZone<0&&!G.confirmed){
        document.getElementById('hint-bar').textContent='HURRY! CHOOSE A DOOR!';
        document.getElementById('hint-bar').style.color='var(--wrong)';
    }
}

function hud(){
    document.getElementById('h-score').textContent=G.score;
}

// Game Start / End
function beginGame(){
    G.challenges=shuffle(CHALLENGES).slice(0,ROUNDS);
    G.round=0; G.score=0; G.results=[]; G.active=false;
    hide('menu'); hide('gameover');
    show('countdown');
    document.getElementById('game-screen').style.display='flex';
    buildGrid();

    let n=3;
    const el=document.getElementById('count-num');
    el.textContent=n;
    const iv=setInterval(()=>{
        n--;
        if(n>0){el.textContent=n;el.className='countdown-num';void el.offsetWidth;el.className='countdown-num';}
        else{clearInterval(iv);hide('countdown');G.active=true;showRound();}
    },700);
}

function endGame(){
    G.active=false; clearInterval(G.tiv);
    clearTimeout(G.lockTimer);
    document.querySelectorAll('.zone-lbl').forEach(l=>l.remove());

    const ptsArr=G.results.map(r=>r.pts);
    const best=Math.max(...ptsArr);
    const worst=Math.min(...ptsArr);
    const avg=Math.round(ptsArr.reduce((a,b)=>a+b,0)/ptsArr.length);

    document.getElementById('final-score').textContent=G.score;
    document.getElementById('s-best').textContent='+'+best;
    document.getElementById('s-worst').textContent=(worst>=0?'+':'')+worst;
    document.getElementById('s-avg').textContent=avg;

    let rank='';
    if(G.score>=200) rank='<span style="color:var(--gold);font-family:Cinzel,serif;">King of Fortune</span>';
    else if(G.score>=150) rank='<span style="color:var(--gold);">โชคดีสุดขีด</span>';
    else if(G.score>=100) rank='<span style="color:var(--purple);">ดวงดีมาก</span>';
    else if(G.score>=60) rank='<span style="color:var(--correct);">ดวงดี</span>';
    else if(G.score>=30) rank='<span style="color:#888;">ดวงกลางๆ</span>';
    else rank='<span style="color:var(--wrong);">ดวงซวย...</span>';
    document.getElementById('luck-rank').innerHTML=rank;

    document.getElementById('results-list').innerHTML=G.results.map((r,i)=>{
        const col=r.pts>=15?'var(--gold)':r.pts>0?'var(--purple)':r.pts===0?'#666':'var(--wrong)';
        return `<div class="result-row">
            <div class="result-dot" style="background:${r.pts>0?'rgba(251,191,36,0.12)':'rgba(100,100,100,0.12)'};color:${col};">${r.pts>=0?'+':''}${r.pts}</div>
            <div><div style="color:#bbb;">${r.cmd}</div><div style="color:${col};font-size:0.62rem;">เลือก: ${r.pick} → ${r.pts>=0?'+':''}${r.pts} คะแนน</div></div>
        </div>`;
    }).join('');
    show('gameover');
}

function goMenu(){
    hide('gameover');
    document.getElementById('game-screen').style.display='none';
    document.querySelectorAll('.zone-lbl').forEach(l=>l.remove());
    show('menu');
}

// Keyboard
document.addEventListener('keydown',e=>{
    if(!G.active) return;
    let dr=0,dc=0;
    const k=e.key.toLowerCase();
    if(k==='w'||k==='arrowup') dr=-1;
    else if(k==='s'||k==='arrowdown') dr=1;
    else if(k==='a'||k==='arrowleft') dc=-1;
    else if(k==='d'||k==='arrowright') dc=1;
    else if(k>='1'&&k<='4'){e.preventDefault();goToZone(parseInt(k)-1);return;}
    else return;
    e.preventDefault();
    G.pr+=dr;G.pc+=dc;
    moveP();checkZone();
});

// Door keyboard activation (Enter/Space)
document.querySelectorAll('.door-card').forEach(d=>{
    d.addEventListener('keydown',e=>{
        if(e.key==='Enter'||e.key===' '){
            e.preventDefault();
            const i=parseInt(d.dataset.i);
            goToZone(i);
        }
    });
});

// Screen reader announcements
function announce(msg){
    const el=document.getElementById('sr-announce');
    if(el){el.textContent='';requestAnimationFrame(()=>{el.textContent=msg;});}
}

window.addEventListener('resize',()=>{if(G.active)moveP();});

// Helpers
function show(id){document.getElementById(id).classList.remove('hidden');}
function hide(id){document.getElementById(id).classList.add('hidden');}
</script>
</body>
</html>
